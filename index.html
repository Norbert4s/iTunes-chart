<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <link rel="stylesheet" href="bootstrap/bootstrap.css">
  <link rel="stylesheet" href="animate/animate.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <title>iTunes top 100</title>
</head>

<body>
  <!-- load html after getting all the data to not trigger transitions and errors that show up for split second if you reload page quickly(because there is no data in that moment) -->
  <div v-if="this.info != null" id="app">
    <h1 class="title">{{ info.title.label }}</h1>
    <div class="displayButtons">
      <span class="toggleAlbums toggleAlbumsAll" v-on:click="showAll()">Top 100</span>
      <span class="toggleAlbums toggleAlbumsFavorites" v-on:click="showFavorites()">Favorites <img src="assets/star-solid.jpg" alt=""></span>
    </div>

    <input class="inputSearch" type="text" v-model="search" placeholder="Search albums..." />

    <ul>
      <span class="noFavorites" v-if="!activeAlbums.length && this.albums.length > 0">No favorites chosen</span>
      <transition-group name="custom-classes-transition" enter-active-class="animated slideInLeft" leave-active-class="animated bounceOutRight">
        <li v-for="(album, index) in filteredAlbums" v-bind:key="index" class="album">

          <div class="basic">
            <img class="favStar" v-bind:src="[album.favorite ? 'assets/star-solid.jpg' : 'assets/star-regular.jpg']" v-on:click='setFavorite(album, index)' alt="">
            <div class="triggerClick" v-on:click="openDetailed(album)">
              <span class="place">{{ album.place }}</span>
              <img class="albumImage" v-bind:src="album['im:image'][2].label" alt="">
              <div class="fullName">
                <span v-bind:class="{'showName': album.isDetailed}" class="albumTitle">{{ album['im:name'].label }}</span>
                <span v-bind:class="{'showName': album.isDetailed}" class="artist">{{ album['im:artist'].label }}</span>
              </div>
              <div class="openArrow" v-bind:class="{'flipArrow': album.isDetailed}">
                <img src="assets/angle-down-solid.svg" alt="">
              </div>
            </div>
          </div>

          <div class="detailed" v-bind:class="{'active': album.isDetailed}">
            <div class="col-xs-4">
              <span class="detailedSpan price"><span class="detailedSpanTitle">Price:</span>{{ album['im:price'].label }}</span>
            </div>
            <div class="col-xs-4">
              <span class="detailedSpan link"><img src="assets/external-link-alt-solid.svg" alt=""></span>
            </div>
            <div class="col-xs-4">
              <span class="detailedSpan date"><span class="detailedSpanTitle">Release date:</span>{{ album['im:releaseDate'].attributes.label }}</span>
            </div>
          </div>
        </li>
        </transitio-group>
    </ul>

    <span class="copyright">{{ info.rights.label }}</span>
  </div>
</body>

</html>

<script type="text/javascript">
  new Vue({
    el: '#app',
    data() {
      return {
        info: null,
        activeAlbums: [],
        albums: [],
        favorites: [],
        search: "",
        loading: true,
        errored: false,
      }
    },
    computed: {
      //Takes all active albums and matches them up with what is being typed into search bar
      filteredAlbums: function() {
        return this.activeAlbums.filter((album) => {
          let regex = new RegExp(this.search, "gi");
          return album.title.label.match(regex);
        })
      }
    },
    methods: {
      openDetailed: function(album) {
        if (album.isDetailed === true) {
          Vue.delete(album, 'isDetailed');
          Vue.set(album, 'isDetailed', false);
        } else {
          Vue.delete(album, 'isDetailed');
          Vue.set(album, 'isDetailed', true);
        }
      },
      setFavorite: function(album, index) {
        if (album.favorite === false) {
          Vue.delete(album, 'favorite');
          Vue.set(album, 'favorite', true);

          this.favorites.push(album);
        } else {
          Vue.delete(album, 'favorite');
          Vue.set(album, 'favorite', false);

          this.favorites.splice(index, 1);
        }
      },
      showFavorites: function() {
        this.activeAlbums = this.favorites;
      },
      showAll: function() {
        this.activeAlbums = this.albums;
      }
    },
    mounted() {
      //Get api and assign data
      axios
        .get('https://itunes.apple.com/us/rss/topalbums/limit=100/json')
        .then(response => {
          this.info = response.data.feed;
          this.albums = this.info.entry;
          this.activeAlbums = this.albums;
          let index = 0;
          for (let album of this.albums) {
            index++;
            album.place = index;
            album.isDetailed = false;
            album.favorite = false;
          }
        })
        .catch(error => {
          console.log(error)
          this.errored = true
        })
        .finally(() => this.loading = false)
    },
  })
</script>
